@startuml Cryptnox SDK Arduino Architecture

!theme plain
scale 1.5

skinparam backgroundColor #FEFEFE
skinparam classBackgroundColor #E8F4FC
skinparam classBorderColor #2C7BB6
skinparam classFontColor #1A1A1A
skinparam classFontSize 16
skinparam classAttributeFontSize 14
skinparam stereotypeFontColor #666666
skinparam stereotypeFontSize 14
skinparam arrowColor #2C7BB6
skinparam arrowFontSize 14
skinparam packageBackgroundColor #F5F5F5
skinparam packageBorderColor #CCCCCC
skinparam packageFontSize 18
skinparam noteFontSize 14
skinparam titleFontSize 24
skinparam defaultFontName "Segoe UI"
skinparam defaultFontSize 14
skinparam wrapWidth 300

title <size:28>Cryptnox SDK Arduino - Architecture Overview</size>

' ============================================
' PACKAGES
' ============================================

package "Cryptnox SDK" <<Frame>> {

    abstract class NFCDriver <<interface>> {
        + {abstract} begin() : bool
        + {abstract} inListPassiveTarget() : bool
        + {abstract} sendAPDU(apdu, apduLen, response, responseLen) : bool
        + {abstract} readUID(uid, uidLength) : bool
        + {abstract} resetReader() : void
        + {abstract} printFirmwareVersion() : bool
        --
        + ~NFCDriver()
    }

    class SecureSession <<struct>> {
        + aesKey[32] : uint8_t
        + macKey[32] : uint8_t
        + iv[16] : uint8_t
        --
        + SecureSession()
        + clear() : void
    }

    class CryptnoxWallet <<core>> {
        - driver : NFCDriver&
        --
        + CryptnoxWallet(driver : NFCDriver&)
        + begin() : bool
        + processCard() : bool
        + selectApdu() : bool
        + getCardCertificate(cardEphemeralPubKey, length) : bool
        + openSecureChannel(salt, pubKey, privKey, curve) : bool
        + mutuallyAuthenticate(session, salt, pubKey, privKey, curve, cardPubKey) : bool
        + readUID(uidBuffer, uidLength) : bool
        + printPN532FirmwareVersion() : bool
        + extractCardEphemeralKey(cert, pubKey, fullKey) : bool
        + printApdu(apdu, length, label) : void
        + checkStatusWord(response, len, sw1, sw2) : bool
        + getCardInfo(session) : void
        + verifyPin(session) : void
        + aes_cbc_encrypt(session, apdu, apduLen, data, dataLen) : void
        + aes_cbc_decrypt(session, response, len, mac) : bool
        --
        - {static} uECC_RNG(dest, size) : int
    }

    enum PN532Interface <<enumeration>> {
        SPI_HARDWARE
        SPI_SOFTWARE
        I2C
        UART
    }

    class PN532Adapter <<adapter>> {
        - interface : PN532Interface
        - nfc : Adafruit_PN532*
        --
        + PN532Adapter(ssPin, theSPI) <<SPI>>
        + PN532Adapter(clk, miso, mosi, ss) <<SW-SPI>>
        + PN532Adapter(irqPin, resetPin, wire) <<I2C>>
        + PN532Adapter(resetPin, uartSerial) <<UART>>
        + ~PN532Adapter()
        + PN532Adapter(const PN532Adapter&) = delete
        + operator=(const PN532Adapter&) = delete
        --
        + begin() : bool
        + readUID(uidBuffer, uidLength) : bool
        + sendAPDU(apdu, apduLen, response, responseLen) : bool
        + inListPassiveTarget() : bool
        + resetReader() : void
        + printFirmwareVersion() : bool
    }
}

package "External Libraries" <<Frame>> #FFFDE7 {
    
    class Adafruit_PN532 <<library>> {
        + begin() : void
        + inDataExchange(send, sendLen, response, responseLen) : bool
        + readPassiveTargetID() : bool
        + SAMConfig() : void
        + getFirmwareVersion() : uint32_t
    }
    
    class AESLib <<library>> {
        + set_paddingmode(mode) : void
        + encrypt(input, len, output, key, keyLen, iv) : uint16_t
        + decrypt(input, len, output, key, keyLen, iv) : uint16_t
    }
    
    class "uECC (micro-ecc)" as uECC <<library>> {
        + uECC_secp256r1() : uECC_Curve_t
        + uECC_make_key(pubKey, privKey, curve) : bool
        + uECC_shared_secret(pubKey, privKey, secret, curve) : int
        + uECC_set_rng(rng_callback) : void
    }

    class SHA512 <<library>> {
        + update(data, len) : void
        + finalize(output, len) : void
    }
}

' ============================================
' RELATIONSHIPS
' ============================================

NFCDriver <|-- PN532Adapter : implements
CryptnoxWallet o--> "1" NFCDriver : uses
CryptnoxWallet ..> SecureSession : "creates & passes"
PN532Adapter --> PN532Interface : uses
PN532Adapter *--> "1" Adafruit_PN532 : owns

CryptnoxWallet ..> AESLib : uses
CryptnoxWallet ..> uECC : uses
CryptnoxWallet ..> SHA512 : uses

Adafruit_PN532 -[hidden]- AESLib

' ============================================
' NOTES
' ============================================

note right of CryptnoxWallet
  **Core SDK Class**
  Manages secure communication
  with Cryptnox smart cards:
  * APDU commands
  * Secure channel (ECDH + AES)
  * PIN verification
  * Key derivation (SHA-512)
end note

note top of SecureSession
  **Reentrant Session Context**
  Holds cryptographic state
  as a stack-local struct:
  * AES encryption key (Kenc)
  * MAC key (Kmac)
  * Rolling IV for AES-CBC
  Passed by reference to
  crypto functions for reentrancy.
end note

note bottom of PN532Adapter
  **Hardware Abstraction**
  Supports multiple interfaces:
  * Hardware SPI (fast)
  * Software SPI (flexible pins)
  * I2C (2-wire)
  * UART (serial)
end note

note right of NFCDriver
  **Driver Interface**
  Allows swapping NFC hardware
  without changing wallet logic
end note

@enduml
